<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Deploy dotnet core application on app engine with github actions - Nicolas Bontempo</title>
  
  <meta name="description" content="In this tutorial, I will describe for you how to set up a Github actions workflow for your project to automatically run your tests, build your app and deploy the new code to google app engine service. At the time of this tutorial the last Dotnet core version supported was 2.1, so I created a docker file to deploy for this tutorial on Dotnet core 3.1.
1- Setup your project The first thing you need to do is create your app engine on the google cloud, for that you should go to the Google Cloud Console and create a project.">
  <meta name="author" content="Nicolas Bontempo">
  
  <link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700,700i" rel="stylesheet">
  <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
  
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
  <link rel="icon" href="/img/favicon.ico">
  
  <link rel="alternate" type="application/atom+xml" href="/index.xml" title="Nicolas Bontempo">
</head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="/"><span>üê±‚Äçüëì</span>Nicolas Bontempo</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/sobre/">About me</a>
        </li>
        
        <li class="">
          <a href="https://github.com/nickbom">Github</a>
        </li>
        
        <li class="">
          <a href="https://www.linkedin.com/in/nicolasbontempo">Linkedin</a>
        </li>
        
        <li class="">
          <a href="/posts/">Posts</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

<article class="post post-view">
  <header class="post-header">
    <h1 class="post-title">Deploy dotnet core application on app engine with github actions</h1>
    <p class="post-meta">Nicolas Bontempo ¬∑08/06/2020
      <div style="color:grey; font-size:16px;">
        <strong>Tags:</strong> 
        <a href="/tags/devops">DevOps</a> 
        <a href="/tags/google-cloud">google cloud</a> 
        <a href="/tags/github-actions">github actions</a> 
      </div>
    </p>
  </header>
  <div class="post-content"><p>In this tutorial, I will describe for you how to set up a Github actions workflow for your project to automatically run your tests, build your app and deploy the new code to google app engine service. At the time of this tutorial the last Dotnet core version supported was 2.1, so I created a docker file to deploy for this tutorial on Dotnet core 3.1.</p>
<h2 id="1--setup-your-project">1- Setup your project</h2>
<p>The first thing you need to do is create your app engine on the google cloud, for that you should go to the <a href="https://console.cloud.google.com/">Google Cloud Console</a> and create a project. With the project created you will go to the app engine tab and enable the creation of app engine applications on this project.</p>
<h2 id="2--configure-the-deploy-on-google-cloud">2- Configure the deploy on google cloud</h2>
<ul>
<li>First let&rsquo;s start configuring the <code>app.yaml</code>, on this <code>app.yaml</code> you will define which stack that you are developing your application and how many resources you will need on the google app engine, there are several configurations diversified on manual scaling and other rules for automatic scaling, this is our code that you will be using on this project:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># Custom because you will be using the docker file to create the runtime</span>
<span style="color:#75715e"># you will need to do that because Dotnet core 3.1 is currently not supported</span>
<span style="color:#66d9ef">runtime</span>: custom
<span style="color:#75715e"># Flexible environment because is what currently supports custom runtime</span>
<span style="color:#66d9ef">env</span>: flex

<span style="color:#75715e"># Automatic scaling configured </span>
<span style="color:#66d9ef">automatic_scaling</span>:
  <span style="color:#66d9ef">min_num_instances</span>: <span style="color:#ae81ff">2</span>
  <span style="color:#66d9ef">max_num_instances</span>: <span style="color:#ae81ff">10</span>
<span style="color:#66d9ef">resources</span>:
  <span style="color:#66d9ef">cpu</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">memory_gb</span>: <span style="color:#ae81ff">0.5</span>
  <span style="color:#66d9ef">disk_size_gb</span>: <span style="color:#ae81ff">10</span>

<span style="color:#75715e"># If you are using a cloud SQL database</span>
<span style="color:#75715e"># this will create a tunnel to your cloud SQL</span>
<span style="color:#75715e"># Then you can use on your application the host as cloud SQL</span>
<span style="color:#75715e"># to point to your database on the application connection string</span>
<span style="color:#66d9ef">beta_settings</span>:
  <span style="color:#66d9ef">cloud_sql_instances</span>: <span style="color:#e6db74">&#34;&lt;NAME OF YOUR CLOUD SQL&gt;:&lt;REGION OF YOUR CLOUD SQL&gt;:&lt;PROJECT ID&gt;=tcp:&lt;PORT OF YOUR CLOUD SQL&gt;&#34;</span>
</code></pre></div><ul>
<li>Second, you will create the docker file</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/aspnet:3.1-buster-slim AS base</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/sdk:3.1-buster AS build</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;&lt;APPLICATION&gt;.csproj&#34;</span>, <span style="color:#e6db74">&#34;&lt;APPLICATION&gt;/&#34;</span><span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet restore <span style="color:#e6db74">&#34;&lt;APPLICATION&gt;.csproj&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> &#34;/src/&lt;APPLICATION&gt;&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet build <span style="color:#e6db74">&#34;&lt;APPLICATION&gt;.csproj&#34;</span> -c Release -o /app/build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> build AS publish</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet publish <span style="color:#e6db74">&#34;&lt;APPLICATION&gt;.csproj&#34;</span> -c Release -o /app/publish<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> base AS final</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>publish /app/publish .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Expose the port 8080 that will be port used by the app engine</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> ASPNETCORE_URLS<span style="color:#f92672">=</span>http://*:8080<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;&lt;APPLICATION&gt;.dll&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><ul>
<li>Finally, let&rsquo;s test with the CLI if everything is working fine
<ul>
<li>Install the CLI, following the <a href="https://cloud.google.com/sdk/docs/quickstarts">docs</a></li>
<li>Now that you configured the CLI, let&rsquo;s start typing <code>gcloud app deploy app.yaml</code></li>
<li>If everything worked fine, you should type <code>gcloud app browse</code> and that will show to you the URI that the app engine exposed your application, you can test your application to see if everything is working fine</li>
</ul>
</li>
</ul>
<h2 id="3--create-the-service-account-on-app-engine">3- Create the &ldquo;Service account&rdquo; on App Engine</h2>
<p>Now that you configured your project to enable the app engine, let&rsquo;s create the service account that you will be using to deploy your code on the google app engine. Go back to the <a href="https://console.cloud.google.com/">Google Cloud Console</a>, open &ldquo;IAM&rdquo; &gt; &ldquo;Service Accounts&rdquo; &gt; &ldquo;Create Service Account&rdquo; follow the steps and create a JSON key.</p>
<p><strong>Roles that you need to have on the service account</strong>:</p>
<ul>
<li>App engine deployer</li>
<li>App Engine Service Admin</li>
<li>Cloud Build Editor</li>
<li>Storage Object Creator</li>
<li>Storage Object Viewer</li>
</ul>
<p>With the JSON key created, open your terminal and press <code>base64 &lt;KEY SERVICE ACCOUNT JSON&gt;</code>, now you will save this key to the Github secrets, go to your project on Github and follow this steps &ldquo;Settings&rdquo; &gt; &ldquo;Secrets&rdquo; create two secrets:</p>
<ul>
<li>&ldquo;GCLOUD_AUTH&rdquo; with the base64 key that you created</li>
<li>&ldquo;PROJECT_ID&rdquo; with the google project id</li>
</ul>
<h2 id="4--configure-the-deploy-on-github-actions">4- Configure the deploy on Github actions</h2>
<p>Now that you had configured your app engine and the secrets on Github, let&rsquo;s create the continuous deploy for your application, create a folder on the root of your project called <code>.github</code>, this folder is responsible for configuring everything related to Github. Inside the <code>.github</code> folder, create a <code>workflows</code> folder that will be responsible for all your automations on Github actions.</p>
<p>So let&rsquo;s create your first workflow, create a <code>build.yml</code> on the workflows folder and your file will look like that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">name</span>: &lt;NAME OF YOUR WORKFLOW<span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"># on all pushes to master this workflow will run</span>
<span style="color:#66d9ef">on</span>:
  <span style="color:#66d9ef">push</span>:
    <span style="color:#66d9ef">branches</span>: [ master ]

<span style="color:#66d9ef">jobs</span>:
  <span style="color:#66d9ef">build</span>:
    <span style="color:#75715e"># you can change SO that the workflow will run</span>
    <span style="color:#66d9ef">runs-on</span>: ubuntu-latest
    <span style="color:#66d9ef">steps</span>:
    - <span style="color:#66d9ef">uses</span>: actions/checkout@v2
    - <span style="color:#66d9ef">name</span>: Setup .NET Core
      <span style="color:#66d9ef">uses</span>: actions/setup-dotnet@v1
      <span style="color:#66d9ef">with</span>:
        <span style="color:#66d9ef">dotnet-version</span>: <span style="color:#ae81ff">3.1.101</span>
    - <span style="color:#66d9ef">name</span>: dotnet Restore
      <span style="color:#66d9ef">run</span>: dotnet restore
    - <span style="color:#66d9ef">name</span>: dotnet Build
      <span style="color:#66d9ef">run</span>: dotnet build --configuration Release --no-restore
    <span style="color:#75715e"># on the tests you can use a package called GitHubActionTestLogger</span>
    <span style="color:#75715e"># that will highlight all the tests that are failing</span>
    <span style="color:#75715e"># the setup is documented on the repo of the package</span>
    - <span style="color:#66d9ef">name</span>: dotnet Test
      <span style="color:#66d9ef">run</span>: dotnet test --logger GitHubActions
    <span style="color:#75715e"># you can replace secrets of the app settings on this step</span>
    <span style="color:#75715e"># (database connection, logging and etc)</span>
    - <span style="color:#66d9ef">uses</span>: microsoft/variable-substitution@v1 
      <span style="color:#66d9ef">with</span>:
        <span style="color:#66d9ef">files</span>: <span style="color:#e6db74">&#39;&lt;PATH&gt;/appsettings.json&#39;</span>
      <span style="color:#66d9ef">env</span>:
        <span style="color:#66d9ef">Secret1</span>: ${{ secrets.GitHubSecret }}
    - <span style="color:#66d9ef">uses</span>: GoogleCloudPlatform/github-actions/setup-gcloud@master
      <span style="color:#66d9ef">with</span>:
        <span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#39;290.0.1&#39;</span>
        <span style="color:#66d9ef">project_id</span>: ${{ secrets.PROJECT_ID }}
        <span style="color:#66d9ef">service_account_key</span>: ${{ secrets.GCLOUD_AUTH }}
        <span style="color:#66d9ef">export_default_credentials</span>: <span style="color:#66d9ef">true</span>
    - <span style="color:#66d9ef">name</span>: Run deployment
      <span style="color:#66d9ef">if</span>: success()
      <span style="color:#66d9ef">run</span>: gcloud app deploy ./app.yaml --quiet
</code></pre></div><p>Now everything should work properly. Please give feedback below, if anything was not clear enough I can always edit and add more information to the article.</p>
<h2 id="needs-more-info">Needs more info?</h2>
<ul>
<li><a href="https://github.com/Tyrrrz/GitHubActionsTestLogger">GitHubActionsTestLogger</a></li>
<li></li>
</ul>
</div>
  <footer class="post-footer">
    
    <ul class="post-tags">
      
      <li>
        <a href="/tags/devops/">DevOps</a>
      </li>
      
      <li>
        <a href="/tags/google-cloud/">google cloud</a>
      </li>
      
      <li>
        <a href="/tags/github-actions/">github actions</a>
      </li>
      
    </ul>
    
  </footer>
  
   
  <div id="disqus_thread"></div>
  <script>
    var disqus_shortname = 'nicolasbontempo';
    (function () { 
      var d = document,
        s = d.createElement('script');
      s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
   
</article>
</main>
<footer class="footer">
  <span>&copy; 2015-2020 Nicolas Bontempo üéâ</span>
</footer>
<script src="https://cdn.bootcss.com/instantclick/3.0.1/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js" data-no-instant></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-71553462-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script data-no-instant>
  hljs.initHighlightingOnLoad();
  menuToggle();
  InstantClick.on('change', function() {
    var blocks = document.querySelectorAll('pre code');
    for (var i = 0; i < blocks.length; i++) {
      hljs.highlightBlock(blocks[i]);
    }
    menuToggle();
  });
  function menuToggle() {
    var $toggle = document.querySelector('.menu-toggle');
    if (!$toggle.offsetParent) {
      return;
    }
    var $body = document.querySelector('body');
    $toggle.addEventListener('click', function() {
      $body.classList.toggle('noscroll');
    }, false);
  }
</script>
</body>
</html>
