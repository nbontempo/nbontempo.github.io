{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/deploy-dotnet-core-application-on-app-engine-with-github-actions","result":{"data":{"markdownRemark":{"id":"583a319b-e464-508d-b8ff-0a1875cfc19f","html":"<p>In this tutorial, I will describe for you how to set up a Github actions workflow and this will enable your project to automatically run your tests, build your app and deploy the new code to google app engine service. At the time of this tutorial the last Dotnet core version supported was 2.1, so I created a docker file to deploy on Dotnet core 3.1.</p>\n<h2 id=\"1--setup-your-project\" style=\"position:relative;\"><a href=\"#1--setup-your-project\" aria-label=\"1  setup your project permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1- Setup your project</h2>\n<p>The first thing you need to do is create your app engine on the google cloud, for that you should go to the <a href=\"https://console.cloud.google.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google Cloud Console</a> and create a project. With the project created you will go to the app engine tab and enable the creation of app engine applications on this project.</p>\n<h2 id=\"2--configure-the-deploy-on-google-cloud\" style=\"position:relative;\"><a href=\"#2--configure-the-deploy-on-google-cloud\" aria-label=\"2  configure the deploy on google cloud permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2- Configure the deploy on google cloud</h2>\n<ul>\n<li>First let’s start configuring the <code class=\"language-text\">app.yaml</code>, on this <code class=\"language-text\">app.yaml</code> you will define which stack that you are developing your application and how many resources you will need on the google app engine, there are several configurations diversified on manual scaling and other rules for automatic scaling, this is our code that you will be using on this project:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># Custom because you will be using the docker file to create the runtime</span>\n<span class=\"token comment\"># you will need to do that because Dotnet core 3.1 is currently not supported</span>\n<span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> custom\n<span class=\"token comment\"># Flexible environment because is what currently supports custom runtime</span>\n<span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span> flex\n\n<span class=\"token comment\"># Automatic scaling configured</span>\n<span class=\"token key atrule\">automatic_scaling</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">min_num_instances</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">max_num_instances</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">memory_gb</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.5</span>\n  <span class=\"token key atrule\">disk_size_gb</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n\n<span class=\"token comment\"># If you are using a cloud SQL database</span>\n<span class=\"token comment\"># this will create a tunnel to your cloud SQL</span>\n<span class=\"token comment\"># Then you can use on your application the host as cloud SQL</span>\n<span class=\"token comment\"># to point to your database on the application connection string</span>\n<span class=\"token key atrule\">beta_settings</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">cloud_sql_instances</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&lt;NAME OF YOUR CLOUD SQL>:&lt;REGION OF YOUR CLOUD SQL>:&lt;PROJECT ID>=tcp:&lt;PORT OF YOUR CLOUD SQL>\"</span></code></pre></div>\n<ul>\n<li>Second, you will create the docker file</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/dotnet/core/aspnet<span class=\"token punctuation\">:</span>3.1<span class=\"token punctuation\">-</span>buster<span class=\"token punctuation\">-</span>slim AS base\n<span class=\"token keyword\">WORKDIR</span> /app\n\n<span class=\"token keyword\">FROM</span> mcr.microsoft.com/dotnet/core/sdk<span class=\"token punctuation\">:</span>3.1<span class=\"token punctuation\">-</span>buster AS build\n<span class=\"token keyword\">WORKDIR</span> /src\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"&lt;APPLICATION>.csproj\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;APPLICATION>/\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">RUN</span> dotnet restore <span class=\"token string\">\"&lt;APPLICATION>.csproj\"</span>\n<span class=\"token keyword\">COPY</span> . .\n<span class=\"token keyword\">WORKDIR</span> <span class=\"token string\">\"/src/&lt;APPLICATION>\"</span>\n<span class=\"token keyword\">RUN</span> dotnet build <span class=\"token string\">\"&lt;APPLICATION>.csproj\"</span> <span class=\"token punctuation\">-</span>c Release <span class=\"token punctuation\">-</span>o /app/build\n\n<span class=\"token keyword\">FROM</span> build AS publish\n<span class=\"token keyword\">RUN</span> dotnet publish <span class=\"token string\">\"&lt;APPLICATION>.csproj\"</span> <span class=\"token punctuation\">-</span>c Release <span class=\"token punctuation\">-</span>o /app/publish\n\n<span class=\"token keyword\">FROM</span> base AS final\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from=publish /app/publish .\n<span class=\"token comment\"># Expose the port 8080 that will be port used by the app engine</span>\n<span class=\"token keyword\">EXPOSE</span> 8080\n<span class=\"token keyword\">ENV</span> ASPNETCORE_URLS=http<span class=\"token punctuation\">:</span>//*<span class=\"token punctuation\">:</span>8080\n<span class=\"token keyword\">ENTRYPOINT</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"dotnet\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;APPLICATION>.dll\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<ul>\n<li>\n<p>Finally, let’s test with the CLI if everything is working fine</p>\n<ul>\n<li>Install the CLI, following the <a href=\"https://cloud.google.com/sdk/docs/quickstarts\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">docs</a></li>\n<li>Now that you configured the CLI, let’s start typing <code class=\"language-text\">gcloud app deploy app.yaml</code></li>\n<li>If everything worked fine, you should type <code class=\"language-text\">gcloud app browse</code> and that will show to you the URI that the app engine exposed your application, you can test your application to see if everything is working fine</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"3--create-the-service-account-on-app-engine\" style=\"position:relative;\"><a href=\"#3--create-the-service-account-on-app-engine\" aria-label=\"3  create the service account on app engine permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3- Create the “Service account” on App Engine</h2>\n<p>Now that you configured your project to enable the app engine, let’s create the service account that you will be using to deploy your code on the google app engine. Go back to the <a href=\"https://console.cloud.google.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google Cloud Console</a>, open “IAM” > “Service Accounts” > “Create Service Account” follow the steps and create a JSON key.</p>\n<p><strong>Roles that you need to have on the service account</strong>:</p>\n<ul>\n<li>App engine deployer</li>\n<li>App Engine Service Admin</li>\n<li>Cloud Build Editor</li>\n<li>Storage Object Creator</li>\n<li>Storage Object Viewer</li>\n</ul>\n<p>With the JSON key created, open your terminal and press <code class=\"language-text\">base64 &lt;KEY SERVICE ACCOUNT JSON&gt;</code>, now you will save this key to the Github secrets, go to your project on Github and follow this steps “Settings” > “Secrets” create two secrets:</p>\n<ul>\n<li>“GCLOUD_AUTH” with the base64 key that you created</li>\n<li>“PROJECT_ID” with the google project id</li>\n</ul>\n<h2 id=\"4--configure-the-deploy-on-github-actions\" style=\"position:relative;\"><a href=\"#4--configure-the-deploy-on-github-actions\" aria-label=\"4  configure the deploy on github actions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4- Configure the deploy on Github actions</h2>\n<p>Now that you had configured your app engine and the secrets on Github, let’s create the continuous deploy for your application, create a folder on the root of your project called <code class=\"language-text\">.github</code>, this folder is responsible for configuring everything related to Github. Inside the <code class=\"language-text\">.github</code> folder, create a <code class=\"language-text\">workflows</code> folder that will be responsible for all your automations on Github actions.</p>\n<p>So let’s create your first workflow, create a <code class=\"language-text\">build.yml</code> on the workflows folder and your file will look like that:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> &lt;NAME OF YOUR WORKFLOW<span class=\"token punctuation\">></span>\n\n<span class=\"token comment\"># on all pushes to master this workflow will run</span>\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>master<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># you can change SO that the workflow will run</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup .NET Core\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>dotnet@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">dotnet-version</span><span class=\"token punctuation\">:</span> 3.1.101\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dotnet Restore\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> dotnet restore\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dotnet Build\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> dotnet build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>configuration Release <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>restore\n      <span class=\"token comment\"># on the tests you can use a package called GitHubActionTestLogger</span>\n      <span class=\"token comment\"># that will highlight all the tests that are failing</span>\n      <span class=\"token comment\"># the setup is documented on the repo of the package</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dotnet Test\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> dotnet test <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>logger GitHubActions\n      <span class=\"token comment\"># you can replace secrets of the app settings on this step</span>\n      <span class=\"token comment\"># (database connection, logging and etc)</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> microsoft/variable<span class=\"token punctuation\">-</span>substitution@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">files</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&lt;PATH>/appsettings.json\"</span>\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">Secret1</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GitHubSecret <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> GoogleCloudPlatform/github<span class=\"token punctuation\">-</span>actions/setup<span class=\"token punctuation\">-</span>gcloud@master\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"290.0.1\"</span>\n          <span class=\"token key atrule\">project_id</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.PROJECT_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">service_account_key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GCLOUD_AUTH <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">export_default_credentials</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Run deployment\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> success()\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> gcloud app deploy ./app.yaml <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>quiet</code></pre></div>\n<p>Now everything should work properly. Please give feedback below, if anything was not clear enough I can always edit and add more information to the article.</p>\n<h2 id=\"needs-more-info\" style=\"position:relative;\"><a href=\"#needs-more-info\" aria-label=\"needs more info permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Needs more info?</h2>\n<ul>\n<li><a href=\"https://github.com/Tyrrrz/GitHubActionsTestLogger\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GitHubActionsTestLogger</a></li>\n<li><a href=\"https://cloud.google.com/appengine/docs/flexible/custom-runtimes\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google App Engine Custom Runtimes for the Flexible Environment documentation</a></li>\n<li><a href=\"https://help.github.com/en/actions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Github actions docs</a></li>\n</ul>","fields":{"slug":"/posts/deploy-dotnet-core-application-on-app-engine-with-github-actions","tagSlugs":["/tag/dev-ops/","/tag/google-cloud/","/tag/github-actions/"]},"frontmatter":{"date":"2020-06-09T01:33:49.000Z","description":"In this tutorial, I will describe for you how to set up a Github actions workflow and this will enable your project to automatically run your tests, build your app and deploy the new code to google app engine service. At the time of this tutorial the last Dotnet core version supported was 2.1, so I created a docker file to deploy on Dotnet core 3.1.","tags":["DevOps","Google Cloud","Github Actions"],"title":"Deploy dotnet core application on app engine with github actions","socialImage":"/media/image-2.jpg"}}},"pageContext":{"slug":"/posts/deploy-dotnet-core-application-on-app-engine-with-github-actions"}}}